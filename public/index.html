<html>
<head>
  <title>TheEyeTribe/hello</title>
  <style>
    body, html {
      margin:0;
      padding:0;
    }
    #content-wrapper {
      position: relative;
      width: 1264px;
      height: 1024px;
    }
    #survey {
      position: absolute;
      top:0;
      left:0;
    }
    #canvas {
      position: absolute;
      top: 0;
      left: 0;
    }
  </style>
  <script type='text/javascript' src="/socket.io/socket.io.js"></script>
  <!--
  <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.4.13/fabric.min.js"></script>
  -->
  <script type='text/javascript' src="lib/fabric.min.js"></script>

</head>
<body>
  <div id="content-wrapper">
    <!-- 1280px - 16px for scrollbar -->
    <iframe id="survey" src="survey/q1.html" width="1264" height="1024"></iframe>
    <canvas id="canvas" width="1264" height="1024"></canvas>
  </div>
  <div class="controls">
    <select id="question">
      <option value="q1" selected>Question 1</option>
      <option value="q2">Question 2</option>
      <option value="q3">Question 3</option>
      <option value="q4">Question 4</option>
      <option value="q4">Question 4</option>
      <option value="q5">Question 5</option>
      <option value="q6a">Question 6a</option>
      <option value="q6b">Question 6b</option>
      <option value="q7">Question 7</option>
      <option value="q8">Question 8</option>
      <option value="q9a">Question 9a</option>
      <option value="q9b">Question 9b</option>
      <option value="q10">Question 10</option>
      <option value="q11a">Question 11a</option>
      <option value="q11b">Question 11b</option>
      <option value="q12">Question 12</option>
      <option value="q13">Question 13</option>
      <option value="q14">Question 14</option>
      <option value="q15">Question 15</option>
      <option value="q16">Question 16</option>
      <option value="q17">Question 17</option>
      <option value="q18">Question 18</option>
      <option value="q19">Question 19</option>
      <option value="q20">Question 20</option>
      <option value="q21">Question 21</option>
      <option value="q22">Question 22</option>
      <option value="q23">Question 23</option>
      <option value="q24">Question 24</option>
      <option value="q25a">Question 25a</option>
      <option value="q25b">Question 25b</option>
    </select>
    <button id="start">Start</button>
  </div>

  <script>
    var socket = io();
    var questionSelect = document.getElementById('question');
    var contentWrapper = document.getElementById('content-wrapper');
    var startButton = document.getElementById('start');
    var qId = 'q1';
    var circles = [];
    var lines = [];
    var bufferSize = 25;
    var radius = 5;

    var canvas = new fabric.Canvas('canvas');

    startButton.addEventListener('click',function() {
      socket.emit('startEyeDataStrean', qId);
      canvas.clear();
    });
    questionSelect.addEventListener('change',function(e) {
      canvas.clear();
      qId = e.target.value;
      var newFrame = document.createElement("iframe");
      newFrame.src = 'survey/' + e.target.value + '.html';
      newFrame.setAttribute('id','survey');
      newFrame.setAttribute('width','1264');
      newFrame.setAttribute('height','1024');
      var oldFrame = document.getElementById('survey');
      contentWrapper.replaceChild(newFrame, oldFrame);
    });

    socket.on('frame', function (data) {
      if (!data.x || !data.y) {
        // eye.style.display = 'none';
      } else {
        var circle = new fabric.Circle({
          left : (data.x-radius),
          top : (data.y-radius),
          radius : radius,
          fill : 'red'
        });
        canvas.add(circle);
        circles.push(circle);
        if (circles.length > 2) {
          var x1 = circles[circles.length-2].left + radius;
          var y1 = circles[circles.length-2].top + radius;
          var line = new fabric.Line([x1, y1, +data.x, +data.y], {
            fill: 'red',
            stroke: 'red',
            strokeWidth: 1,
            selectable: false
          })
          lines.push(line);
          canvas.add(line);
          if (circles.length > bufferSize) {
            circles.shift().remove();
            lines.shift().remove();
          }
        }
      }
    });
  </script>
</body>
</html>
